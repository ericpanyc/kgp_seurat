---
title: "Schwannoma sample VS4 analysis"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(error = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_knit$set(root.dir = "/Users/lufeixiaoxin/Downloads/usc_folder/kgp/seurat")
```

Load packages needed
```{r}
library(dplyr)
library(Seurat)
library(patchwork)
library(tibble)
library(AnnotationHub)
library(limma)
library(xCell)
library(biomaRt)
library(ggplot2)
library(ggpubr)
library(purrr)
```

Get annotation information, gene name, entrez id and gene id
```{r}
ah <- AnnotationHub()
ahDb <- query(ah, 
              pattern = c("Homo sapiens", "EnsDb"), 
              ignore.case = TRUE)
id <- ahDb %>%
        mcols() %>%
        rownames() %>%
        tail(n = 1)
edb <- ah[[id]]
annotations <- genes(edb, 
                     return.type = "data.frame")
annotations <- annotations %>%
        dplyr::select(gene_id, gene_name, entrezid,description)
annotations$entrezid <- as.character(annotations$entrezid)

head(annotations, 10)
```

Read in 10x outputs direcotry and make seurat object (barcodes, features, matrix)
```{r}
VS4.data <- Read10X(data.dir = "/Users/lufeixiaoxin/Downloads/usc_folder/kgp/seurat/VS4_filtered_feature_bc_matrix")
VS4 <- CreateSeuratObject(counts = VS4.data, project = "VS4", min.features = 100)

VS4
```

QC and selecting cells for further analysis
Find mitochondrial genes
```{r}
VS4[["percent.mt"]] <- PercentageFeatureSet(VS4, pattern = "^MT-")

summary(VS4@meta.data$nFeature_RNA)

VlnPlot(VS4, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
```

Remove outliers in the dataset
```{r}
VS4 <- subset(VS4, subset = nFeature_RNA > 200 & nFeature_RNA < 6000 & percent.mt < 20)
```

Normalize data
```{r}
VS4 <- NormalizeData(VS4)
VS4 <- FindVariableFeatures(VS4, selection.method = "vst", nfeatures = 2000)
```

Identification of highly variable features
```{r, fig.width=14, fig.height=12}
top10 <- head(VariableFeatures(VS4), 10)

plot1 <- VariableFeaturePlot(VS4)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot1 + plot2
```

Scale data
```{r}
all.genes <- rownames(VS4)
VS4 <- ScaleData(VS4, features = all.genes)
```

Find PCAs
```{r}
VS4 <- RunPCA(VS4, features = VariableFeatures(object = VS4))
print(VS4[["pca"]], dims = 1:5, nfeatures = 5)
```

Cluster the cells
```{r}
VS4 <- FindNeighbors(VS4, dims = 1:10)
VS4 <- FindClusters(VS4, resolution = c(0.4, 0.6, 0.8, 1.0, 1.4))

```

Check VS4 object information
```{r}
VS4@meta.data %>% View()
```

Set VS4 to resolution of 0.4 (lower resolution)
```{r}
Idents(object = VS4) <- "RNA_snn_res.0.4"
```

Check cluster ID
```{r}
head(Idents(VS4), 5)
```

Dimensional reduction on UMAP
```{r}
VS4 <- RunUMAP(VS4, dims = 1:10)
DimPlot(VS4, reduction = "umap", label = T)
```

Find marker genes for each cluster and integret annotations
```{r}
VS4.markers <- FindAllMarkers(VS4, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
VS4.markers <- VS4.markers %>% group_by(cluster) %>% top_n(n = 30, wt = avg_logFC)
VS4.markers <- left_join(x = VS4.markers, y = unique(annotations[, c("gene_name", "description","entrezid")]),
                         by = c("gene" = "gene_name"))
```

Check annotated clusters 6 and 11
```{r}
view(VS4.markers[which(VS4.markers$cluster == 6),c("gene", "description")])
view(VS4.markers[which(VS4.markers$cluster == 11),c("gene", "description")])
```

Find GO pathway enrichment for each cluster (top 15 entries)
```{r}
markers_by_cluster <- lapply(unique(VS4.markers$cluster), function(i) VS4.markers[VS4.markers$cluster == i,])
markers_by_cluster <- lapply(markers_by_cluster, function(i) i[[9]])
cluster_go_annotation <- lapply(markers_by_cluster, function(i) goana(i) %>% topGO(n=15))
cluster_go_annotation <- lapply(cluster_go_annotation, function(i) i[[1]])
```

Check pathways of cluster 1 and 8
```{r}
cluster_go_annotation[2]
cluster_go_annotation[9]
```

Find marker gene distribution
Mesenchymal cells
```{r}
FeaturePlot(VS4, features = c("ANGPT1", "CRLF1", 
                              "CCL2", "CCL3", "SEMA4F", 
                              "INHBB", "LIF", "NGF"), label = T)
```

Fibroblast
```{r}
VlnPlot(VS4, features = c("ACTA2","FAP","PDGFRB","SPARC"))
```

Schwann cells
```{r}
VlnPlot(VS4, features = c("SOX10","S100A1","MPZ","ERBB2"))
```

M2 macrophage
```{r}
VlnPlot(VS4, features = c("ADGRE1","CD80","TGFB1","LGMN","CD68","CD163"))
```

DC
```{r}
VlnPlot(VS4, features = c("CD83","CST3","ITGAX"))
```

Export gene list to xcell
Read in bulk rna sequencing data
```{r}
sch_data <- read.table("/Users/lufeixiaoxin/Downloads/usc_folder/kgp/xcell/schwann_data/tpm_matrix/schwann_seq_data",header=T, as.is=TRUE, sep = "\t")
sch_data <- left_join(x = sch_data, y = unique(annotations[, c("gene_name","gene_id")]),
                         by = c("ID" = "gene_id"))
sch_data <- sch_data %>% mutate_all(na_if,"")
sch_data <- sch_data[!is.na(sch_data$gene_name),]
```

Find all genes expressed in cluster 8 and 11
```{r}
gene_cluster <- AverageExpression(object = VS4)[[1]]
gene_cluster <- rownames_to_column(gene_cluster, var = "name") %>% as.data.frame()
gene_in_cluster11 <- gene_cluster[which(gene_cluster$`11` > 0),c("name", 11)]
gene_in_cluster8 <- gene_cluster[which(gene_cluster$`8` > 0),c("name", 8)]
```

Keep bulk RNA seq data to genes expresed in cluster 8 and 11
```{r}
sch_data_11 <- sch_data[which(sch_data$gene_name %in% gene_in_cluster11$name),]
sch_data_8 <- sch_data[which(sch_data$gene_name %in% gene_in_cluster8$name),]
```

Transform the dataframe
```{r}
rownames(sch_data_11) <- make.names(sch_data_11$gene_name, unique = T)
rownames(sch_data_8) <- make.names(sch_data_8$gene_name, unique = T)

sch_data_11 <- sch_data_11[,-c(1,13)]
sch_data_8 <- sch_data_8[,-c(1,13)]
```

Prepare group information
```{r}
condition <- substring(names(sch_data_11),8,10)
condition <- as.factor(rep(condition, 67))
sample_id <- substring(names(sch_data_11),3,6)
sample_id <- as.factor(rep(sample_id,67))
```


Run xcell analysis on cluster 11 genes and draw boxplot
```{r}
xcell_result <- xCellAnalysis(sch_data_11)
xcell_result <- as.data.frame(t(xcell_result))
xcell_boxplot_data <- stack(xcell_result)
xcell_boxplot_data <- cbind(xcell_boxplot_data, condition, sample_id)
names(xcell_boxplot_data)[c(1,2)] <- c("enrichment_score","cell_type")

p <- ggboxplot(xcell_boxplot_data, x = "cell_type", y = "enrichment_score",
               fill = "condition", palette = "jco", outlier.size=0.5, outlier.colour="purple") + 
        theme_gray(base_size = 14) +
        theme(axis.text.x = element_text(size = 6, angle = 45, hjust = 0.9)) + 
        ggtitle("cluster 11 expressed genes xcell analysis") +
        scale_y_continuous(limits = c(-0.02,0.7),expand = expand_scale(mult = c(0, .1)))

p + stat_compare_means(aes(group = condition), label = "p.signif", method = "t.test",
                       symnum.args = list(cutpoints = c(0, 0.1, 1), symbols = c("*", "ns")),
                       hide.ns = T,
                       label.y = -0.019)
```

Similarly, make a xcell plot on cluster 8 specific genes
```{r}
xcell_result <- xCellAnalysis(sch_data_8)
xcell_result <- as.data.frame(t(xcell_result))
xcell_boxplot_data <- stack(xcell_result)
xcell_boxplot_data <- cbind(xcell_boxplot_data, condition, sample_id)
names(xcell_boxplot_data)[c(1,2)] <- c("enrichment_score","cell_type")

p <- ggboxplot(xcell_boxplot_data, x = "cell_type", y = "enrichment_score",
               fill = "condition", palette = "jco", outlier.size=0.5, outlier.colour="purple") + 
        theme_gray(base_size = 14) +
        theme(axis.text.x = element_text(size = 6, angle = 45, hjust = 0.9)) + 
        ggtitle("cluster 8 expressed genes xcell analysis") +
        scale_y_continuous(limits = c(-0.02,0.7),expand = expand_scale(mult = c(0, .1)))

p + stat_compare_means(aes(group = condition), label = "p.signif", method = "t.test",
                       symnum.args = list(cutpoints = c(0, 0.1, 1), symbols = c("*", "ns")),
                       hide.ns = T,
                       label.y = -0.019)
```

